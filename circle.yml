dependencies:
  cache_directories:
    - ${HOME}/examples/
    - ${HOME}/afni/
    - ${HOME}/fsl/
    - ${HOME}/downloads/
  override:
    - pip install --upgrade pip
    - pip install numpy
    - pip install -r requirements.txt
    - pip install -e .
machine:
  pre:
    - mkdir -p ${HOME}/downloads
    - mkdir -p ${HOME}/tmp
    - if [[ ! -d ${HOME}/fsl ]]; then wget -P ${HOME}/downloads/ "http://fsl.fmrib.ox.ac.uk/fsldownloads/fsl-5.0.9-centos6_64.tar.gz"; cd ${HOME}/tmp; tar zxvf ${HOME}/downloads/fsl-5.0.9-centos6_64.tar.gz; mv fsl ${HOME}/fsl; fi
    - source ${HOME}/fsl/etc/fslconf/fsl.sh
    - if [[ ! -d ${HOME}/afni ]]; then wget -P ${HOME}/downloads/ "http://afni.nimh.nih.gov/pub/dist/tgz/linux_openmp_64.tgz"; cd ${HOME}/tmp; tar zxvf ${HOME}/downloads/linux_openmp_64.tgz; mv linux_openmp_64 ${HOME}/afni; fi
    - if [[ ! -d ${HOME}/examples/ds003_downsampled ]]; then wget -P ${HOME}/downloads/ "https://googledrive.com/host/0B2JWN60ZLkgkMEw4bW5VUUpSdFU/ds003_downsampled.tar"; mkdir -p ${HOME}/examples; tar xvf ${HOME}/downloads/ds003_downsampled.tar -C ${HOME}/examples; fi
  environment:
    PATH: ${HOME}/afni:${HOME}/fsl/bin:${PATH}
    FSLDIR: ${HOME}/fsl
    LD_LIBRARY_PATH: ${HOME}/fsl/lib:${LD_LIBRARY_PATH}
    FSLOUTPUTTYPE: NIFTI_GZ
test:
  override:
    # Test new qcp smart script, first only one case.
    - echo "sub-01" > inclusion_file && python scripts/qap_bids_data_sublist_generator.py --include inclusion_file ${HOME}/examples/ds003_downsampled/ ${HOME}/bids_subjects_sub-01.yml
    - python scripts/qcp.py --sublist ${HOME}/bids_subjects_sub-01.yml configs/qap_config_ds003.yml:
        environment:
          PATH: ${HOME}/afni:${HOME}/fsl/bin:${PATH}
          FSLDIR: ${HOME}/fsl
          LD_LIBRARY_PATH: ${HOME}/fsl/lib:${LD_LIBRARY_PATH}
          FSLOUTPUTTYPE: NIFTI_GZ
    - python scripts/qap_bids_data_sublist_generator.py ${HOME}/examples/ds003_downsampled/ ${HOME}/bids_subjects.yml
    - python scripts/qcp.py --sublist ${HOME}/bids_subjects.yml configs/qap_config_ds003_ms.yml
    # First three tests only on one subject
    - echo "sub-01" > inclusion_file && python scripts/qap_bids_data_sublist_generator.py -t functional --include inclusion_file ${HOME}/examples/ds003_downsampled/ ${HOME}/bids_func_sub-01.yml
    - python scripts/qap_functional_spatial.py --sublist ${HOME}/bids_func_sub-01.yml configs/qap_config_ds003.yml
    - python scripts/qap_functional_temporal.py --sublist ${HOME}/bids_func_sub-01.yml configs/qap_config_ds003.yml
    - echo "sub-01" > inclusion_file && python scripts/qap_bids_data_sublist_generator.py -t anatomical --include inclusion_file ${HOME}/examples/ds003_downsampled/ ${HOME}/bids_anat_sub-01.yml
    - python scripts/qap_anatomical_spatial.py --sublist ${HOME}/bids_anat_sub-01.yml configs/qap_config_ds003.yml
    # Second three tests on multiple subjects, two subjects at once (qap_config_ds003_ms.yml)
    # Anatomical spatial set to last, since it takes longer
    - python scripts/qap_bids_data_sublist_generator.py -t functional ${HOME}/examples/ds003_downsampled/ ${HOME}/bids_func_list.yml
    - python scripts/qap_functional_spatial.py --sublist ${HOME}/bids_func_list.yml configs/qap_config_ds003_ms.yml
    - python scripts/qap_functional_temporal.py --sublist ${HOME}/bids_func_list.yml configs/qap_config_ds003_ms.yml
    - python scripts/qap_bids_data_sublist_generator.py -t anatomical ${HOME}/examples/ds003_downsampled/ ${HOME}/bids_anat_list.yml
    - python scripts/qap_anatomical_spatial.py --sublist ${HOME}/bids_anat_list.yml configs/qap_config_ds003_ms.yml
general:
  artifacts:
    - "/tmp/output"
    - "/tmp/workdir"
    - "/tmp/output_ms"
    - "/tmp/workdir_ms"
    - "${HOME}/bids_subjects.yml"
    - "${HOME}/bids_subjects_sub-01.yml"
    - "${HOME}/bids_anat_sub-01.yml"
    - "${HOME}/bids_func_sub-01.yml"
    - "${HOME}/bids_anat_list.yml"
    - "${HOME}/bids_func_list.yml"
